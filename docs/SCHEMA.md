
# Staylo SaaS - Firestore Schema Design

## 1. Core Principles

This Firestore schema is designed for a production-grade, multi-hotel booking SaaS platform. It is built on the following principles:

-   **Scalability**: Data is denormalized and structured in flat collections to allow for efficient, large-scale queries without hitting single-document limits.
-   **Security**: The schema is designed to work with granular Firestore Security Rules. Access control is managed by referencing a user's role and their association with specific hotels.
-   **Flexibility**: The model supports complex business logic like dynamic pricing, date-wise inventory, multi-role users, and future integrations with Online Travel Agencies (OTAs).

---

## 2. Root Collections

### `/users`

Stores public-facing information for all users (guests, admins). Private or sensitive data is stored elsewhere.

-   **Document ID**: `uid` (Firebase Authentication User ID)
-   **Fields**:
    -   `uid` (string): The user's unique Firebase Auth ID.
    -   `email` (string): User's primary email address.
    -   `displayName` (string): User's full name.
    -   `photoURL` (string, nullable): URL for the user's profile picture.
    -   `createdAt` (timestamp): Server timestamp of account creation.
-   **Example Document**:
    ```json
    {
      "uid": "abc123xyz456",
      "email": "guest@example.com",
      "displayName": "John Doe",
      "photoURL": "https://example.com/photo.jpg",
      "createdAt": "2023-10-27T10:00:00Z"
    }
    ```

### `/hotels`

The central collection for all hotel properties on the platform.

-   **Document ID**: Auto-generated by Firestore (e.g., `hotel_12345`).
-   **Fields**:
    -   `name` (string): The official name of the hotel.
    -   `description` (string): A detailed marketing description.
    -   `address` (map): Physical location details.
        -   `street` (string)
        -   `city` (string)
        -   `state` (string)
        -   `postalCode` (string)
        -   `country` (string)
    -   `location` (geopoint): Firestore GeoPoint for map-based queries.
    -   `imageUrls` (array of strings): URLs for the hotel's photo gallery.
    -   `amenities` (array of strings): List of offered amenities (e.g., "wifi", "pool").
    -   `starRating` (number): The hotel's star rating (e.g., 4.5).
    -   `contact` (map): Public contact information.
        -   `phone` (string)
        -   `email` (string)
    -   `isActive` (boolean): `true` if the hotel is live and bookable.
    -   `createdAt` (timestamp): Server timestamp of when the hotel was added.
-   **Example Document**:
    ```json
    {
      "name": "The Grand Palace",
      "description": "A luxurious hotel in the heart of the city.",
      "address": { "street": "123 Royal Rd", "city": "Jaipur", "state": "Rajasthan", "postalCode": "302001", "country": "IN" },
      "location": "[26.9124, 75.7873]",
      "imageUrls": ["https://.../image1.jpg"],
      "amenities": ["wifi", "pool", "gym"],
      "starRating": 5,
      "contact": { "phone": "9876543210", "email": "contact@grandpalace.com" },
      "isActive": true,
      "createdAt": "2023-10-27T10:00:00Z"
    }
    ```

### `/rooms`

Stores the definitions of room *types* for each hotel. This is the master record for a room category.

-   **Document ID**: Auto-generated by Firestore (e.g., `room_67890`).
-   **Fields**:
    -   `hotelId` (string): Foreign key referencing the parent `/hotels` document. **(Indexed)**
    -   `roomTypeId` (string, nullable): An internal hotel system or OTA identifier (e.g., "DLX_KNG").
    -   `name` (string): The name of the room type (e.g., "Deluxe King Room").
    -   `description` (string): Marketing description of the room.
    -   `capacity` (number): Maximum number of guests allowed.
    -   `beds` (map): Description of the bed configuration.
        -   `king` (number)
        -   `queen` (number)
        -   `twin` (number)
    -   `imageUrls` (array of strings): URLs for photos of this specific room type.
    -   `amenities` (array of strings): List of in-room amenities.
    -   `totalInventory` (number): The total number of physical rooms of this type that the hotel has.
-   **Example Document**:
    ```json
    {
      "hotelId": "hotel_12345",
      "roomTypeId": "DLX_KNG",
      "name": "Deluxe King Room",
      "description": "Spacious room with a city view and a king-sized bed.",
      "capacity": 2,
      "beds": { "king": 1 },
      "imageUrls": ["https://.../deluxe-king.jpg"],
      "amenities": ["minibar", "safe", "coffee_maker"],
      "totalInventory": 10
    }
    ```

### `/availability`

The most dynamic collection, storing the price and number of available rooms for a specific room type on a specific date.

-   **Document ID**: `{roomId}_{YYYY-MM-DD}` (Composite ID for fast lookups, e.g., `room_67890_2024-12-25`).
-   **Fields**:
    -   `roomId` (string): Foreign key referencing the `/rooms` document. **(Indexed)**
    -   `hotelId` (string): Denormalized foreign key for hotel-level queries. **(Indexed)**
    -   `date` (string): The date for this entry in `YYYY-MM-DD` format. **(Indexed)**
    -   `price` (number): The price for this room on this specific night (in smallest currency unit, e.g., paise).
    -   `roomsAvailable` (number): The number of rooms of this type available for booking on this date.
-   **Example Document**:
    ```json
    {
      "roomId": "room_67890",
      "hotelId": "hotel_12345",
      "date": "2024-12-25",
      "price": 1500000,
      "roomsAvailable": 8
    }
    ```

### `/bookings`

Contains a record for every booking made on the platform.

-   **Document ID**: Auto-generated by Firestore (e.g., `booking_abcde`).
-   **Fields**:
    -   `userId` (string): Foreign key referencing the `/users` document of the guest. **(Indexed)**
    -   `hotelId` (string): Foreign key referencing the `/hotels` document. **(Indexed)**
    -   `roomId` (string): Foreign key referencing the `/rooms` document. **(Indexed)**
    -   `checkInDate` (string): `YYYY-MM-DD` format.
    -   `checkOutDate` (string): `YYYY-MM-DD` format.
    -   `numGuests` (number): Number of guests for the booking.
    -   `totalAmount` (number): Total price paid (in smallest currency unit).
    -   `status` (string): The current state of the booking (e.g., "confirmed", "cancelled", "completed"). **(Indexed)**
    -   `bookedAt` (timestamp): Server timestamp of when the booking was made.
    -   `paymentId` (string, nullable): Foreign key referencing the `/payments` document.
-   **Example Document**:
    ```json
    {
      "userId": "abc123xyz456",
      "hotelId": "hotel_12345",
      "roomId": "room_67890",
      "checkInDate": "2024-12-24",
      "checkOutDate": "2024-12-26",
      "numGuests": 2,
      "totalAmount": 3000000,
      "status": "confirmed",
      "bookedAt": "2023-11-15T14:30:00Z",
      "paymentId": "payment_fghij"
    }
    ```

### `/favorites`

Stores a user's favorited hotels. Uses a composite ID to prevent duplicates.

-   **Document ID**: `{userId}_{hotelId}`
-   **Fields**:
    -   `userId` (string): Foreign key referencing the `/users` document. **(Indexed)**
    -   `hotelId` (string): Foreign key referencing the `/hotels` document. **(Indexed)**
    -   `createdAt` (timestamp): Server timestamp.
-   **Example Document**:
    ```json
    {
      "userId": "abc123xyz456",
      "hotelId": "hotel_12345",
      "createdAt": "2023-10-27T10:00:00Z"
    }
    ```

### `/payments`

A ledger of all financial transactions.

-   **Document ID**: Auto-generated by Firestore (e.g., `payment_fghij`).
-   **Fields**:
    -   `bookingId` (string): Foreign key referencing the `/bookings` document. **(Indexed)**
    -   `userId` (string): Foreign key referencing the user who paid. **(Indexed)**
    -   `amount` (number): The amount paid (in smallest currency unit).
    -   `currency` (string): e.g., "INR".
    -   `status` (string): "succeeded", "failed", "pending".
    -   `provider` (string): The payment gateway used (e.g., "stripe", "razorpay").
    -   `providerTransactionId` (string): The ID from the payment gateway.
    -   `createdAt` (timestamp): Server timestamp.
-   **Example Document**:
    ```json
    {
      "bookingId": "booking_abcde",
      "userId": "abc123xyz456",
      "amount": 3000000,
      "currency": "INR",
      "status": "succeeded",
      "provider": "stripe",
      "providerTransactionId": "pi_12345",
      "createdAt": "2023-11-15T14:30:00Z"
    }
    ```
    
### `/admins`
This collection is key for Role-Based Access Control. It links users to the hotels they manage.
-   **Document ID**: Auto-generated by Firestore.
-   **Fields**:
    -   `userId` (string): The `uid` of the user being granted admin rights. **(Indexed)**
    -   `hotelId` (string, nullable): Foreign key to `/hotels`. `null` for `super_admin`. **(Indexed)**
    -   `role` (string): The user's role. Can be `hotel_admin` or `super_admin`. **(Indexed)**
-   **Example Document (Hotel Admin)**:
    ```json
    {
        "userId": "user_hotel_owner_1",
        "hotelId": "hotel_12345",
        "role": "hotel_admin"
    }
    ```
-   **Example Document (Super Admin)**:
    ```json
    {
        "userId": "user_super_admin_1",
        "hotelId": null,
        "role": "super_admin"
    }
    ```

---

## 3. Schema Functionality Explanations

-   **Inventory Management**: A `hotel_admin` can update the `roomsAvailable` field in the `/availability` collection for their `hotelId` and a specific date range. A booking transaction atomically decrements this value, preventing overbooking.
-   **Price Updates**: A `hotel_admin` updates the `price` field in the `/availability` collection for specific dates. This allows for seasonal or event-based dynamic pricing.
-   **Multi-Property Owners**: A single user (`userId`) can have multiple entries in the `/admins` collection, each linking them to a different `hotelId` with the `hotel_admin` role. Security rules will check if a user is an admin for the specific hotel they are trying to manage.
-   **Secure User Access**: Security rules will be written based on this structure.
    -   A guest can only read their own `/bookings` (`request.auth.uid == resource.data.userId`).
    -   A `hotel_admin` can only update `/rooms` or `/availability` where the `hotelId` matches one they are linked to in the `/admins` collection.
    -   A `super_admin` would have broader read/write access defined in the rules.
-   **Scalability**: By keeping collections flat, we avoid issues with deep nesting. For example, to get all bookings for a hotel, we query the `/bookings` collection where `hotelId` matches, which is highly efficient at scale, rather than trying to read a massive, deeply nested hotel document.

